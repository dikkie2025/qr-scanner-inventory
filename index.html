<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± –°–∫–∞–Ω–µ—Ä Orto –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
        }
        .logo {
            font-size: 40px;
            margin-bottom: 10px;
        }
        h1 { 
            color: #333; 
            margin-bottom: 5px;
            font-size: 22px;
        }
        .subtitle { 
            color: #666; 
            margin-bottom: 15px;
            font-size: 14px;
        }
        .filter-info {
            background: #fff3cd;
            border: 1px solid #ffecb5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #856404;
            font-weight: bold;
        }
        .filter-info .prefix {
            background: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-family: monospace;
        }
        #reader { 
            width: 100%; 
            height: 300px; 
            border: 3px solid #ddd; 
            border-radius: 10px;
            background: #f8f9fa;
        }
        .buttons { 
            display: flex; 
            gap: 10px; 
            margin: 20px 0; 
        }
        button { 
            flex: 1; 
            padding: 16px; 
            border-radius: 10px; 
            font-size: 16px; 
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #startBtn { 
            background: #28a745; 
            color: white; 
        }
        #startBtn:hover { background: #218838; }
        #stopBtn { 
            background: #dc3545; 
            color: white; 
        }
        #stopBtn:hover { background: #c82333; }
        #historyBtn {
            background: #6c757d;
            color: white;
        }
        #historyBtn:hover { background: #5a6268; }
        .scan-result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-valid {
            background: #d4edda;
            color: #155724;
        }
        .status-invalid {
            background: #f8d7da;
            color: #721c24;
        }
        #resultText {
            font-family: monospace;
            font-size: 16px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            word-break: break-all;
            margin-bottom: 15px;
        }
        .qr-preview {
            text-align: center;
            margin: 15px 0;
        }
        .qr-preview img {
            width: 120px;
            height: 120px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
        }
        .status-message { 
            padding: 15px; 
            border-radius: 10px; 
            margin: 10px 0; 
            display: none; 
            text-align: center;
            font-weight: bold;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .success { 
            background: #d4edda; 
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning { 
            background: #fff3cd; 
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #6c757d;
            font-size: 12px;
        }
        .instructions {
            background: #e7f5ff;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
        }
        .instructions ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .instructions li {
            margin: 5px 0;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .test-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }
        .valid-test { background: #28a745; }
        .invalid-test { background: #dc3545; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-code {
            font-family: monospace;
            font-size: 14px;
        }
        .history-time {
            font-size: 12px;
            color: #6c757d;
        }
        
        @media (max-width: 600px) {
            .container { padding: 15px; }
            #reader { height: 250px; }
            .buttons { flex-direction: column; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="header">
            <div class="logo">ü¶∑</div>
            <h1>–°–∫–∞–Ω–µ—Ä Orto –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏</h1>
            <p class="subtitle">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–ª—å–∫–æ QR-–∫–æ–¥—ã –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "orto"</p>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∏–ª—å—Ç—Ä–µ -->
        <div class="filter-info">
            üîç –°–∫–∞–Ω–µ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–¥—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º: 
            <span class="prefix">orto</span>
            <div style="font-size: 12px; margin-top: 5px; font-weight: normal;">
                –ü—Ä–∏–º–µ—Ä: orto-12345, orto-chair-001, ortodesk-2024
            </div>
        </div>
        
        <!-- –û–±–ª–∞—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div id="reader"></div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="buttons">
            <button id="startBtn">
                <span>‚ñ∂</span>
                <span>–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
            </button>
            <button id="stopBtn" style="display:none;">
                <span>‚èπ</span>
                <span>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</span>
            </button>
            <button id="historyBtn" onclick="showHistory()">
                <span>üìã</span>
                <span>–ò—Å—Ç–æ—Ä–∏—è</span>
            </button>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="scan-result" id="scanResult">
            <div class="result-header">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
                <div class="status-badge" id="statusBadge"></div>
            </div>
            <div id="resultText"></div>
            <div class="qr-preview" id="qrPreview"></div>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å -->
        <div class="status-message" id="statusMessage"></div>
        
        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
        <div class="instructions">
            <p><strong>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong></p>
            <ul>
                <li>–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"</li>
                <li>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ</li>
                <li>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ Orto</li>
                <li>–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç –∫–æ–¥ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –≤ Telegram</li>
                <li>–ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–¥—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è</li>
            </ul>
            
            <div class="test-buttons">
                <button class="valid-test" onclick="testValidCode()">
                    –¢–µ—Å—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (orto-001)
                </button>
                <button class="invalid-test" onclick="testInvalidCode()">
                    –¢–µ—Å—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (other-001)
                </button>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalScans">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ —Å–∫–∞–Ω–æ–≤</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="validScans">0</div>
                <div class="stat-label">–í–∞–ª–∏–¥–Ω—ã—Ö</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="rejectedScans">0</div>
                <div class="stat-label">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
            </div>
        </div>
        
        <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #666;">
            <p>–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª–µ –Ω–∏–∂–µ:</p>
            <input type="text" id="telegramToken" placeholder="–¢–æ–∫–µ–Ω –±–æ—Ç–∞" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" id="telegramChatId" placeholder="Chat ID" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
            <button onclick="saveTelegramConfig()" style="background: #17a2b8; color: white; width: 100%; margin-top: 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã –ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                <button class="close-modal" onclick="hideHistory()">√ó</button>
            </div>
            <div class="history-list" id="historyList"></div>
            <button onclick="clearHistory()" style="background: #dc3545; color: white; width: 100%; margin-top: 15px;">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            <button onclick="exportHistory()" style="background: #28a745; color: white; width: 100%; margin-top: 10px;">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const ORTO_PREFIX = "orto"; // –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
        const ORTO_PREFIX_LENGTH = 4; // –î–ª–∏–Ω–∞ "orto"
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram (–±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage)
        let telegramConfig = {
            token: localStorage.getItem('telegram_token') || '',
            chatId: localStorage.getItem('telegram_chat_id') || ''
        };
        
        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let scanner = null;
        let scanHistory = JSON.parse(localStorage.getItem('scan_history') || '[]');
        let stats = JSON.parse(localStorage.getItem('scan_stats') || '{"total":0,"valid":0,"rejected":0}');
        
        // ========== –≠–õ–ï–ú–ï–ù–¢–´ –°–¢–†–ê–ù–ò–¶–´ ==========
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const scanResult = document.getElementById('scanResult');
        const resultText = document.getElementById('resultText');
        const statusBadge = document.getElementById('statusBadge');
        const statusMessage = document.getElementById('statusMessage');
        const qrPreview = document.getElementById('qrPreview');
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const totalScansEl = document.getElementById('totalScans');
        const validScansEl = document.getElementById('validScans');
        const rejectedScansEl = document.getElementById('rejectedScans');
        
        // Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const telegramTokenInput = document.getElementById('telegramToken');
        const telegramChatIdInput = document.getElementById('telegramChatId');
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateStats();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram
            if (telegramConfig.token) {
                telegramTokenInput.value = telegramConfig.token;
                telegramChatIdInput.value = telegramConfig.chatId;
            }
            
            // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
            startBtn.addEventListener('click', startScanner);
            stopBtn.addEventListener('click', stopScanner);
            
            console.log('–°–∫–∞–Ω–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:', ORTO_PREFIX);
        }
        
        // ========== –°–ö–ê–ù–ï–† ==========
        async function startScanner() {
            try {
                scanner = new Html5Qrcode("reader");
                
                const config = { 
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                };
                
                await scanner.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanError
                );
                
                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                
                showStatus("üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ. –ò—â–µ–º QR-–∫–æ–¥—ã Orto...", "warning");
                
            } catch (error) {
                showStatus("‚ùå –û—à–∏–±–∫–∞: " + error.message, "error");
            }
        }
        
        async function stopScanner() {
            if (scanner) {
                try {
                    await scanner.stop();
                    startBtn.style.display = 'block';
                    stopBtn.style.display = 'none';
                    showStatus("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "error");
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:", error);
                }
            }
        }
        
        // ========== –ü–†–û–í–ï–†–ö–ê –ò –û–ë–†–ê–ë–û–¢–ö–ê QR-–ö–û–î–ê ==========
        async function onScanSuccess(decodedText) {
            // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä
            if (scanner) {
                await scanner.pause();
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            resultText.textContent = decodedText;
            scanResult.style.display = 'block';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å
            const isOrtoCode = checkOrtoPrefix(decodedText);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            stats.total++;
            
            if (isOrtoCode) {
                // –í–ê–õ–ò–î–ù–´–ô –∫–æ–¥ Orto
                stats.valid++;
                statusBadge.textContent = "‚úÖ –í–ê–õ–ò–î–ù–´–ô";
                statusBadge.className = "status-badge status-valid";
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                addToHistory(decodedText, true);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                showStatus(`‚úÖ –ü—Ä–∏–Ω—è—Ç –∫–æ–¥ Orto: ${decodedText}`, "success");
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
                if (telegramConfig.token && telegramConfig.chatId) {
                    await sendToTelegram(decodedText);
                }
                
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä QR
                createQRPreview(decodedText);
                
            } else {
                // –ù–ï–í–ê–õ–ò–î–ù–´–ô –∫–æ–¥
                stats.rejected++;
                statusBadge.textContent = "‚ùå –ù–ï–í–ê–õ–ò–î–ù–´–ô";
                statusBadge.className = "status-badge status-invalid";
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –∫–∞–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–π
                addToHistory(decodedText, false);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                showStatus(`‚ùå –ö–æ–¥ –æ—Ç–∫–ª–æ–Ω–µ–Ω. –î–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å "${ORTO_PREFIX}"`, "error");
                
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–≤—å—é
                qrPreview.innerHTML = '';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∏ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            updateStats();
            localStorage.setItem('scan_stats', JSON.stringify(stats));
            
            // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(async () => {
                if (scanner) {
                    await scanner.resume();
                    
                    // –ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    scanResult.style.display = 'none';
                    statusMessage.style.display = 'none';
                }
            }, 3000);
        }
        
        function onScanError(error) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –æ—à–∏–±–∫–∏
        }
        
        // ========== –ü–†–û–í–ï–†–ö–ê –ü–†–ï–§–ò–ö–°–ê "orto" ==========
        function checkOrtoPrefix(code) {
            // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            const lowerCode = code.toLowerCase().trim();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:
            // 1. –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ —Å "orto"
            // 2. –ò–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç "orto" –∫–∞–∫ —á–∞—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ (—Å –¥–µ—Ñ–∏—Å–æ–º/–ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ–º)
            
            // –í–∞—Ä–∏–∞–Ω—Ç 1: –°—Ç—Ä–æ–≥–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "orto"
            if (lowerCode.startsWith(ORTO_PREFIX)) {
                return true;
            }
            
            // –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 4-5 —Å–∏–º–≤–æ–ª–æ–≤
            const firstPart = lowerCode.substring(0, ORTO_PREFIX_LENGTH + 1);
            if (firstPart.includes(ORTO_PREFIX)) {
                return true;
            }
            
            return false;
        }
        
        // ========== –†–ê–ë–û–¢–ê –° –ò–°–¢–û–†–ò–ï–ô ==========
        function addToHistory(code, isValid) {
            const scanRecord = {
                id: Date.now(),
                code: code,
                isValid: isValid,
                timestamp: new Date().toISOString(),
                timeDisplay: new Date().toLocaleString('ru-RU')
            };
            
            scanHistory.unshift(scanRecord); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
            if (scanHistory.length > 100) {
                scanHistory = scanHistory.slice(0, 100); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            }
            
            localStorage.setItem('scan_history', JSON.stringify(scanHistory));
        }
        
        function showHistory() {
            const modal = document.getElementById('historyModal');
            const historyList = document.getElementById('historyList');
            
            if (scanHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666;">–ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç–∞</p>';
            } else {
                let html = '';
                scanHistory.forEach(record => {
                    const status = record.isValid ? '‚úÖ' : '‚ùå';
                    html += `
                        <div class="history-item">
                            <div>
                                <div class="history-code">${status} ${record.code}</div>
                                <div class="history-time">${record.timeDisplay}</div>
                            </div>
                        </div>
                    `;
                });
                historyList.innerHTML = html;
            }
            
            modal.style.display = 'flex';
        }
        
        function hideHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }
        
        function clearHistory() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è?')) {
                scanHistory = [];
                localStorage.setItem('scan_history', JSON.stringify(scanHistory));
                showHistory();
            }
        }
        
        function exportHistory() {
            let csv = 'ID;QR –∫–æ–¥;–°—Ç–∞—Ç—É—Å;–î–∞—Ç–∞/–≤—Ä–µ–º—è\n';
            scanHistory.forEach(record => {
                const status = record.isValid ? 'VALID' : 'REJECTED';
                csv += `${record.id};${record.code};${status};${record.timeDisplay}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `orto_scans_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showStatus('üì• –ò—Å—Ç–æ—Ä–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ CSV', 'success');
        }
        
        // ========== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==========
        function updateStats() {
            totalScansEl.textContent = stats.total;
            validScansEl.textContent = stats.valid;
            rejectedScansEl.textContent = stats.rejected;
        }
        
        // ========== TELEGRAM ==========
        function saveTelegramConfig() {
            const token = telegramTokenInput.value.trim();
            const chatId = telegramChatIdInput.value.trim();
            
            if (token && chatId) {
                telegramConfig.token = token;
                telegramConfig.chatId = chatId;
                
                localStorage.setItem('telegram_token', token);
                localStorage.setItem('telegram_chat_id', chatId);
                
                showStatus('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            } else {
                showStatus('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è', 'warning');
            }
        }
        
        async function sendToTelegram(qrData) {
            try {
                const url = `https://api.telegram.org/bot${telegramConfig.token}/sendMessage`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: telegramConfig.chatId,
                        text: `ü¶∑ Orto Scan\n‚úÖ –ö–æ–¥: ${qrData}\nüïê –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}\nüì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: –ú–æ–±–∏–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä`,
                        parse_mode: 'HTML'
                    })
                });
                
                if (response.ok) {
                    console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram:', qrData);
                    return true;
                } else {
                    console.error('–û—à–∏–±–∫–∞ Telegram API:', await response.text());
                    return false;
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', error);
                return false;
            }
        }
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
            
            // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }
        
        function createQRPreview(text) {
            // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É QR –∫–æ–¥–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(text)}`;
            qrPreview.innerHTML = `<img src="${qrUrl}" alt="QR Preview">`;
        }
        
        // ========== –¢–ï–°–¢–û–í–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function testValidCode() {
            const testCodes = [
                'orto-001',
                'ORTO-CHAIR-2024',
                'ortodesk-15',
                'orto_stool_blue',
                'OrtoMonitor-27inch'
            ];
            const randomCode = testCodes[Math.floor(Math.random() * testCodes.length)];
            onScanSuccess(randomCode);
        }
        
        function testInvalidCode() {
            const testCodes = [
                'office-001',
                'chair-15',
                'desk_black',
                'monitor-samsung',
                'other-product'
            ];
            const randomCode = testCodes[Math.floor(Math.random() * testCodes.length)];
            onScanSuccess(randomCode);
        }
        
        // ========== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
        document.addEventListener('DOMContentLoaded', init);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                hideHistory();
            }
        });
    </script>
</body>
</html>