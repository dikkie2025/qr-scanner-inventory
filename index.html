<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orto Scanner</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f2f5;
            color: #333;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        h1 {
            font-size: 20px;
            color: #0056a3;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 12px;
            color: #666;
        }
        
        #reader {
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }
        
        #reader video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-primary {
            background: #0056a3;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .stat-box {
            flex: 1;
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #0056a3;
        }
        
        .stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        .codes-list {
            background: white;
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        
        .code-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #0056a3;
            font-family: monospace;
            font-size: 13px;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 13px;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 1000;
            display: none;
        }
        
        .cam-selector {
            margin-bottom: 10px;
        }
        
        select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Orto Scanner</h1>
            <div class="subtitle">–ë—ã—Å—Ç—Ä–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–æ–≤</div>
        </div>
        
        <div class="cam-selector">
            <select id="cameraSelect">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>
            </select>
        </div>
        
        <div id="reader"></div>
        
        <div class="controls">
            <button class="btn btn-primary" id="startBtn">
                <span>‚ñ∂</span>
                <span>–°—Ç–∞—Ä—Ç</span>
            </button>
            <button class="btn btn-danger" id="stopBtn" style="display: none;">
                <span>‚èπ</span>
                <span>–°—Ç–æ–ø</span>
            </button>
            <button class="btn btn-danger" id="clearBtn" disabled>
                <span>üóëÔ∏è</span>
                <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
            </button>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-value" id="count">0</div>
                <div class="stat-label">–ö–æ–¥–æ–≤</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="speed">0/—Å–µ–∫</div>
                <div class="stat-label">–°–∫–æ—Ä–æ—Å—Ç—å</div>
            </div>
        </div>
        
        <div class="codes-list" id="codesList">
            <div class="empty-state" id="emptyState">
                –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å
            </div>
        </div>
        
        <button class="btn btn-success" id="sendBtn" disabled style="width: 100%; margin-bottom: 10px;">
            <span>üì§</span>
            <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</span>
        </button>
        
        <div style="text-align: center; font-size: 11px; color: #999; margin-top: 10px;">
            –ü—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: <span id="totalCount">0</span> –∫–æ–¥–æ–≤
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const ORTO_PREFIX = "orto";
        let telegramConfig = {
            token: localStorage.getItem('telegram_token') || '8268453985:AAF-MD3ywHPsZlK8y0ETzFefNaXOq4bd4Og',
            chatId: localStorage.getItem('telegram_chat_id') || '2132584938'
        };
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let scanner = null;
        let scannedCodes = new Set();
        let lastScanTime = 0;
        let scanTimes = [];
        let selectedCameraId = '';
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const elements = {
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            clearBtn: document.getElementById('clearBtn'),
            sendBtn: document.getElementById('sendBtn'),
            codesList: document.getElementById('codesList'),
            emptyState: document.getElementById('emptyState'),
            count: document.getElementById('count'),
            speed: document.getElementById('speed'),
            totalCount: document.getElementById('totalCount'),
            notification: document.getElementById('notification'),
            cameraSelect: document.getElementById('cameraSelect')
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–æ–¥—ã
            loadSavedCodes();
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä
            await getCameras();
            
            // –°–æ–±—ã—Ç–∏—è
            elements.startBtn.addEventListener('click', startScanner);
            elements.stopBtn.addEventListener('click', stopScanner);
            elements.clearBtn.addEventListener('click', clearCodes);
            elements.sendBtn.addEventListener('click', sendToTelegram);
            elements.cameraSelect.addEventListener('change', (e) => {
                selectedCameraId = e.target.value;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            setInterval(updateSpeed, 1000);
            
            // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                if (!selectedCameraId && elements.cameraSelect.options.length > 1) {
                    selectedCameraId = elements.cameraSelect.options[1].value;
                    elements.cameraSelect.value = selectedCameraId;
                }
                startScanner();
            }, 1000);
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä
        async function getCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                videoDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `–ö–∞–º–µ—Ä–∞ ${elements.cameraSelect.options.length}`;
                    elements.cameraSelect.appendChild(option);
                });
                
                if (videoDevices.length === 0) {
                    showNotification('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∫–∞–º–µ—Ä—ã', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–µ—Ä:', error);
                showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–∞–º', 'error');
            }
        }
        
        // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
        async function startScanner() {
            if (scanner && scanner.isScanning) return;
            
            try {
                // –°–æ–∑–¥–∞–µ–º —Å–∫–∞–Ω–µ—Ä
                scanner = new Html5Qrcode("reader");
                
                // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                const config = {
                    fps: 20,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                    disableFlip: false
                };
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                await scanner.start(
                    selectedCameraId ? 
                        { deviceId: { exact: selectedCameraId } } : 
                        { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanError
                );
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                elements.startBtn.style.display = 'none';
                elements.stopBtn.style.display = 'flex';
                showNotification('–°–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞:', error);
                
                // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥
                try {
                    await scanner.start(
                        { facingMode: "user" },
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        onScanSuccess,
                        onScanError
                    );
                    
                    elements.startBtn.style.display = 'none';
                    elements.stopBtn.style.display = 'flex';
                    showNotification('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞', 'warning');
                    
                } catch (secondError) {
                    showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', 'error');
                }
            }
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
        async function stopScanner() {
            if (scanner) {
                try {
                    await scanner.stop();
                    elements.startBtn.style.display = 'flex';
                    elements.stopBtn.style.display = 'none';
                    showNotification('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'warning');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', error);
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function onScanSuccess(decodedText) {
            const code = decodedText.trim();
            const now = Date.now();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å
            if (!code.toLowerCase().startsWith(ORTO_PREFIX)) {
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç
            if (scannedCodes.has(code)) {
                return;
            }
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            if (now - lastScanTime < 100) return; // 100ms –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            
            lastScanTime = now;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–¥
            scannedCodes.add(code);
            scanTimes.push(now);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            saveCodes();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI();
            
            // –ë—ã—Å—Ç—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showQuickNotification(code);
        }
        
        function onScanError(error) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤
        function loadSavedCodes() {
            const saved = localStorage.getItem('scanned_codes');
            if (saved) {
                try {
                    const codes = JSON.parse(saved);
                    scannedCodes = new Set(codes);
                    updateUI();
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–¥–æ–≤:', e);
                }
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–¥–æ–≤
        function saveCodes() {
            try {
                localStorage.setItem('scanned_codes', JSON.stringify([...scannedCodes]));
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            const count = scannedCodes.size;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            elements.count.textContent = count;
            elements.totalCount.textContent = count;
            elements.clearBtn.disabled = count === 0;
            elements.sendBtn.disabled = count === 0;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            if (count === 0) {
                elements.emptyState.style.display = 'block';
                elements.codesList.innerHTML = '';
                elements.codesList.appendChild(elements.emptyState);
            } else {
                elements.emptyState.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∫–æ–¥–æ–≤
                const codes = Array.from(scannedCodes).slice(-10);
                let html = '';
                
                codes.forEach((code, index) => {
                    const shortCode = code.length > 30 ? code.substring(0, 30) + '...' : code;
                    html += `<div class="code-item">${shortCode}</div>`;
                });
                
                elements.codesList.innerHTML = html;
                elements.codesList.scrollTop = elements.codesList.scrollHeight;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
        function updateSpeed() {
            const now = Date.now();
            const oneSecondAgo = now - 1000;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ–∫—É–Ω–¥—É
            scanTimes = scanTimes.filter(time => time > oneSecondAgo);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            elements.speed.textContent = `${scanTimes.length}/—Å–µ–∫`;
            
            // –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
            if (scanTimes.length >= 3) {
                elements.speed.style.color = '#28a745';
            } else if (scanTimes.length >= 1) {
                elements.speed.style.color = '#f0ad4e';
            } else {
                elements.speed.style.color = '#dc3545';
            }
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –∫–æ–¥–æ–≤
        function clearCodes() {
            if (scannedCodes.size === 0) return;
            
            if (confirm(`–û—á–∏—Å—Ç–∏—Ç—å ${scannedCodes.size} –∫–æ–¥–æ–≤?`)) {
                scannedCodes.clear();
                scanTimes = [];
                localStorage.removeItem('scanned_codes');
                updateUI();
                showNotification('–ö–æ–¥—ã –æ—á–∏—â–µ–Ω—ã', 'warning');
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
        async function sendToTelegram() {
            if (scannedCodes.size === 0) return;
            
            const codes = Array.from(scannedCodes);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const timestamp = new Date().toLocaleString('ru-RU');
            let message = `ü¶∑ *Orto –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è*\n`;
            message += `üìÖ ${timestamp}\n`;
            message += `üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${codes.length}\n\n`;
            message += `*–°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤:*\n`;
            
            codes.forEach((code, index) => {
                message += `${index + 1}. \`${code}\`\n`;
            });
            
            message += `\n‚úÖ *–ò—Ç–æ–≥–æ:* ${codes.length} —à—Ç.`;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
            try {
                elements.sendBtn.disabled = true;
                elements.sendBtn.innerHTML = '<span>‚è≥</span><span>–û—Ç–ø—Ä–∞–≤–∫–∞...</span>';
                
                const url = `https://api.telegram.org/bot${telegramConfig.token}/sendMessage`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: telegramConfig.chatId,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                if (response.ok) {
                    showNotification(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${codes.length} –∫–æ–¥–æ–≤`, 'success');
                    clearCodes();
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram', 'error');
                console.error('–û—à–∏–±–∫–∞:', error);
            } finally {
                elements.sendBtn.disabled = false;
                elements.sendBtn.innerHTML = '<span>üì§</span><span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</span>';
            }
        }
        
        // –ë—ã—Å—Ç—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showQuickNotification(code) {
            const shortCode = code.length > 15 ? code.substring(0, 15) + '...' : code;
            showNotification(`‚úÖ ${shortCode}`, 'success');
        }
        
        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(text, type = 'info') {
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            
            elements.notification.textContent = text;
            elements.notification.style.backgroundColor = colors[type] || colors.info;
            elements.notification.style.display = 'block';
            
            setTimeout(() => {
                elements.notification.style.display = 'none';
            }, 1500);
        }
        
        // –ó–∞–ø—É—Å–∫
        document.addEventListener('DOMContentLoaded', init);
        
        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (scanner && scanner.isScanning) {
                    stopScanner();
                } else {
                    startScanner();
                }
            }
            
            if (e.code === 'Escape') {
                clearCodes();
            }
            
            if (e.code === 'Enter' && !elements.sendBtn.disabled) {
                sendToTelegram();
            }
        });
    </script>
</body>
</html>